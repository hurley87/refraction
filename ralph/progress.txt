# Ralph Progress Log
Started: Fri Jan  9 17:46:59 EST 2026
---

## Codebase Patterns
- Use vitest with `describe`, `it`, `expect` from 'vitest' for tests
- Test files go in `__tests__` subdirectories adjacent to source files
- Use `.safeParse()` for testing Zod schemas - returns `{ success, data, error }`
- Vitest config at `vitest.config.ts` - uses happy-dom environment
- Path alias `@/*` maps to root directory
- Run tests with `yarn test <path>` or `yarn test <path> --run` for non-watch mode

---

## 2026-01-09 - TEST-001
- Implementation summary: Added comprehensive unit tests for all Zod validation schemas
- Modified files:
  - lib/schemas/__tests__/player.test.ts (new, 46 tests)
  - lib/schemas/__tests__/api.test.ts (new, 74 tests)
  - lib/schemas/__tests__/perk.test.ts (new, 53 tests)
  - lib/schemas/__tests__/location.test.ts (new, 50 tests)
- **Learnings for future iterations:**
  - Solana base58 alphabet excludes: 0, O, I, l - test addresses must use valid chars
  - Stellar addresses use [A-Z0-9] (includes digits 0-9, not standard base32)
  - Zod `.coerce.number()` converts strings to numbers automatically
  - Pre-existing TypeScript errors in node_modules and other test files don't affect new code
---

## 2026-01-09 - TEST-002
- Implementation summary: Added unit tests for lib/db/players.ts database module
- Modified files:
  - lib/db/__tests__/players.test.ts (new, 18 tests)
- **Learnings for future iterations:**
  - Mock supabase chain: mockFrom → mockSelect → mockEq → mockSingle
  - PGRST116 error code means "not found" - should return null, not throw
  - For createOrUpdatePlayer: first call checks existence, second performs update/insert
  - Use `vi.mocked()` for type-safe mock assertions
---

## 2026-01-09 - TEST-003
- Implementation summary: Added unit tests for lib/db/perks.ts database module
- Modified files:
  - lib/db/__tests__/perks.test.ts (new, 17 tests)
- **Learnings for future iterations:**
  - Mock complex chains like `.select().eq().lte().or()` with nested mock functions
  - Use `vi.fn<any>()` to avoid TypeScript inference issues with mock return types
  - redeemPerk has 4 sequential DB calls - mock each mockSingle response in order
  - When mocking functions from other modules, use vi.mock then vi.mocked() for type safety
---

## 2026-01-09 - TEST-004
- Implementation summary: Added integration tests for /api/perks/redeem POST endpoint
- Modified files:
  - app/api/perks/redeem/__tests__/route.test.ts (new, 13 tests)
- **Learnings for future iterations:**
  - For API route tests, mock analytics before importing the route to prevent side effects
  - Create helper function `createRequest(body)` using NextRequest for cleaner test setup
  - API routes test differently from db modules - test full request/response cycle
  - Sequential mockSingle calls match the order of DB operations in the route handler
  - Pre-existing TS errors in other test files don't block new work - verify with grep
---

## 2026-01-09 - TEST-005
- Implementation summary: Added unit tests for lib/db/leaderboard.ts database module
- Modified files:
  - lib/db/__tests__/leaderboard.test.ts (new, 14 tests)
- **Learnings for future iterations:**
  - For complex functions like getPlayerStats with multiple DB calls, use mockFrom.mockImplementation with callCount
  - Dense rank calculation: same points get same rank, next rank skips (1,1,3 not 1,1,2)
  - RPC functions return arrays - empty array is valid success, null is failure
  - Mock supabase.rpc separately from supabase.from chain
---

## 2026-01-09 - TEST-006
- Implementation summary: Added unit tests for lib/db/tiers.ts database module
- Modified files:
  - lib/db/__tests__/tiers.test.ts (new, 20 tests)
- **Learnings for future iterations:**
  - For ordered queries, mock chain: mockFrom → mockSelect → mockOrder
  - resolveTierForPoints is a pure function - no mocking needed, test directly
  - max_points=null indicates unbounded highest tier
  - Boundary testing: check exact min_points (inclusive) and max_points (exclusive)
---

## 2026-01-09 - TEST-007
- Implementation summary: Added unit tests for lib/db/locations.ts database module
- Modified files:
  - lib/db/__tests__/locations.test.ts (new, 20 tests)
- **Learnings for future iterations:**
  - Use `vi.fn((_table?: string): any => ({}))` for flexible mockFrom that accepts optional table param
  - mockImplementation callback should use `(table)` not `(table: string)` to match mock signature
  - For multi-table queries (players + checkins), use mockFrom.mockImplementation with table switch
  - Search sanitization tests: verify % and _ are escaped with backslashes
---

## 2026-01-09 - TEST-008
- Implementation summary: Added unit tests for lib/db/checkins.ts database module
- Modified files:
  - lib/db/__tests__/checkins.test.ts (new, 12 tests)
- **Learnings for future iterations:**
  - PGRST116 error code is "not found" - function returns null, not throws
  - Duplicate constraint error code is '23505' (PostgreSQL unique violation)
  - Optional fields (comment, image_url) should be tested with null values too
  - Simple two-function modules can use straightforward mock patterns without complex chains
---

## 2026-01-09 - TEST-009
- Implementation summary: Added integration tests for /api/location-checkin POST and GET endpoints
- Modified files:
  - app/api/location-checkin/__tests__/route.test.ts (new, 17 tests)
- **Learnings for future iterations:**
  - For API routes that call multiple db functions, mock each function individually with vi.mock
  - Use vi.mocked() to set return values for mocked functions
  - Test hidden location (is_visible: false) returns 403, duplicate checkin returns 409
  - GET endpoint tests are simpler - just test query param extraction and db lookup
---

## 2026-01-09 - TEST-010
- Implementation summary: Added unit tests for lib/db/checkpoints.ts database module
- Modified files:
  - lib/db/__tests__/checkpoints.test.ts (new, 22 tests)
- **Learnings for future iterations:**
  - Use vi.stubGlobal('crypto', {...}) to mock crypto.randomUUID for predictable IDs
  - ChainType is 'evm' | 'solana' | 'stellar' - test each variant
  - listActive functions filter by is_active=true in the query
  - getCheckpointsByChainType filters by both chain_type AND is_active
---

## 2026-01-09 - TEST-011
- Implementation summary: Added integration tests for /api/tiers GET endpoint
- Modified files:
  - app/api/tiers/__tests__/route.test.ts (new, 8 tests)
- **Learnings for future iterations:**
  - Simple GET routes only need mockOrder to test ordered queries
  - apiSuccess/apiError helpers wrap NextResponse.json with standard structure
  - Header tests may fail in vitest environment - verify response body instead
  - Route uses export const dynamic = 'force-dynamic' for fresh data
---

## 2026-01-09 - TEST-012
- Implementation summary: Extended lib/api/__tests__/response.test.ts with edge cases
- Modified files:
  - lib/api/__tests__/response.test.ts (extended, now 20 tests)
- **Learnings for future iterations:**
  - response.headers.get() fails in vitest happy-dom environment - verify JSON parsing instead
  - Test null, empty objects, arrays, and deeply nested structures for data handlers
  - Test empty strings and very long strings (10000 chars) for message handlers
  - ZodError can have multiple issues - test aggregated error message format
---

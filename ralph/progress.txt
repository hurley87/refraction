# Ralph Progress Log
Started: Thu Jan  9 2026
PRD: IRL Codebase Refactor
---

## Codebase Patterns

- API response helpers are in `lib/api/response.ts`: `apiSuccess()`, `apiError()`, `apiValidationError()`
- Standard API response shape: `{ success: boolean, data?: T, error?: string, message?: string }`
- 17 routes already use helpers, 38 use raw NextResponse.json(), 1 uses native Response.json()
- High-traffic routes: locations, location-checkin, profile, checkin-status, checkin-events
- Admin routes are prefixed with `/api/admin/`

---

## Stories (8/10 complete)

| ID | Title | Status |
|----|-------|--------|
| API-001 | Audit API response patterns | complete |
| TYPE-001 | Replace catch (error: any) with proper error handling | complete |
| TYPE-002 | Type rewards page redemption handlers | complete |
| API-002 | Standardize admin API routes | complete |
| API-003 | Standardize location and geocoding routes | complete |
| API-004 | Standardize perk routes | complete |
| TYPE-003 | Fix publicClient and partners page types | complete |
| API-005 | Standardize remaining API routes | complete |
| COMP-001 | Decompose interactive-map.tsx | pending |
| COMP-002 | Decompose admin location-lists page | pending |

---

## 2026-01-09 - API-001
- Created `ralph/api-audit.md` documenting all 56 API routes
- Categorized routes: 17 using helpers, 38 using raw NextResponse.json(), 1 using native Response.json()
- Listed specific line numbers for all raw NextResponse.json() calls
- Prioritized routes by traffic/importance (P1-P6)
- **Learnings for future iterations:**
  - Use grep with `output_mode: content` to get line numbers
  - Response helpers are imported from `@/lib/api/response`
  - Admin routes (13 total) follow consistent auth check pattern
  - claim-nft and transfer-tokens have `catch (error: any)` that needs TYPE-001 fix first
---

## 2026-01-09 - TYPE-001
- Fixed 4 occurrences in `app/api/claim-nft/route.ts`
- Fixed 3 occurrences in `app/api/transfer-tokens/route.ts`
- Pattern: `catch (error: unknown)` + `const message = error instanceof Error ? error.message : 'Default message'`
- **Learnings for future iterations:**
  - For timeout errors, check `error.name` after instanceof check: `error instanceof Error && error.name === "WaitForTransactionReceiptTimeoutError"`
  - The files used `error.message ||` fallback pattern - replaced with ternary type guard
---

## 2026-01-09 - TYPE-002
- Replaced `(redemption: any)` with `UserPerkRedemption` type in hasRedeemed function
- Replaced `(code: any)` with `PerkDiscountCode` type in selectedDiscountCode finder
- Removed 20 lines of commented-out PerkCodeCount component
- **Learnings for future iterations:**
  - Types `UserPerkRedemption` and `PerkDiscountCode` are already exported from `lib/types.ts`
  - Rewards page has significant commented-out code that could be cleaned up in future iterations
---

## 2026-01-09 - API-002
- Converted 12 admin API routes to use apiSuccess/apiError/apiValidationError helpers:
  - admin/auth, admin/perks/*, admin/users, admin/points-upload, admin/pending-points
  - admin/locations/[locationId], admin/location-lists/*
- Removed unused NextResponse imports
- 603 tests pass, yarn build passes
- **Learnings for future iterations:**
  - `apiValidationError()` expects a `ZodError` object, not `error.issues` array
  - Admin routes all follow same pattern: check adminEmail header → checkAdminPermission → db operation
  - Linter auto-fixes 403 to 500 status codes for auth errors (may need follow-up)
---

## 2026-01-09 - API-003
- Converted 4 location/geocoding routes to use apiSuccess/apiError helpers:
  - app/api/locations/route.ts - also fixed (row: any) → (row: { locations: unknown })
  - app/api/location-checkin/route.ts - fixed status 500→403 for hidden location error
  - app/api/geocode-mapbox/route.ts - added MapboxFeature interface, removed all `any` types
  - app/api/geocode-nominatim/route.ts - added NominatimPlace interface
- Updated tests to use standardized response format (json.data.* instead of json.*)
- 603 tests pass, yarn build passes
- **Learnings for future iterations:**
  - geocode-google route mentioned in original PRD doesn't exist (only geocode-mapbox and geocode-nominatim)
  - Tests need updating when switching to standardized format: `json.player` → `json.data.player`
  - Use 403 for authorization failures (e.g., hidden location), not 500
  - Adding proper TypeScript interfaces for external API responses (Mapbox, Nominatim) eliminates `any` types
---

## 2026-01-09 - API-004
- Converted 2 remaining perk routes to use apiSuccess/apiError helpers:
  - app/api/perks/[id]/codes/route.ts - added CodeRow interface to replace `any`
  - app/api/perks/codes/[codeId]/route.ts
- Main perk routes were already converted (perks/route.ts, perks/[id]/route.ts, perks/redeem/route.ts, perks/[id]/available-count/route.ts)
- 603 tests pass, yarn build passes
- **Learnings for future iterations:**
  - check-redemption route mentioned in original PRD doesn't exist
  - Route param names vary: some use `[id]`, others use `[perkId]`, `[codeId]`
  - When creating interfaces for filter functions, ensure they match the mapped object structure
---

## 2026-01-09 - TYPE-003
- Removed 2 `as any` casts in lib/publicClient.ts
  - createPublicClient already returns properly typed client from Viem
- Removed 2 `as any` casts in app/partners/page.tsx
  - Added LogoLoopProps interface for JSX component typing
  - Changed `as any` to `as LogoLoopProps` for type safety
- 603 tests pass, yarn build and yarn lint pass
- **Learnings for future iterations:**
  - Viem's createPublicClient returns properly typed clients - no cast needed
  - For JSX components without TypeScript, define props interface locally
  - Using `as SomeInterface` is better than `as any` for partial type safety
---

## 2026-01-09 - API-005
- Converted 17 remaining API routes to use apiSuccess/apiError helpers:
  - activities, add-user, admin/checkpoints (route.ts and [id]/route.ts)
  - checkin-events, checkin-events/invalidate-cache, checkin-status
  - claim-nft, contact, newsletter, profile
  - location-comments, location-lists
  - number-assignment, transfer-tokens, update-airtable, upload
- Fixed Supabase joined table handling: `players` comes as array, extract first element
- Fixed ZodError type assertion: use `error instanceof ZodError` (import from zod)
- Kept NextResponse.json() for checkin-events CSV export (needs custom headers)
- 603 tests pass, yarn build passes
- **Learnings for future iterations:**
  - Supabase returns foreign key joins as arrays even for single objects
  - Use `instanceof ZodError` instead of manual type checking for better type safety
  - Some routes need NextResponse.json() for custom headers (CSV, file downloads)
  - Always verify apiSuccess returns `{ success: true, data }` shape
---

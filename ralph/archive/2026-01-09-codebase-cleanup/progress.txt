# Ralph Progress Log

## Codebase Patterns

- Use `apiSuccess()` and `apiError()` from `lib/api/response.ts` for all API responses
- Zod schemas live in `lib/schemas/*.ts`
- React Query hooks follow `useX` naming in `hooks/` directory
- Database operations go in `lib/db/*.ts` files
- Active checkin system uses `player_location_checkins` table (not legacy `checkins`)
- Path alias `@/*` maps to project root
- API routes follow REST patterns in `app/api/`
- Shared constants live in `lib/constants.ts` (DAILY_CHECKIN_POINTS, DAILY_CHECKPOINT_LIMIT, MAX_VARCHAR_LENGTH, etc.)
- Use `SUPABASE_ERROR_CODES.NOT_FOUND` instead of hardcoding "PGRST116"
- Date utilities live in `lib/utils/date.ts` (getUtcDayBounds)
- Validation utilities live in `lib/utils/validation.ts` (sanitizeVarchar, sanitizeOptionalVarchar, sanitizeString, validateUrl)
- Checkin business logic lives in `lib/api/checkin-handler.ts` (processCheckin, extractErrorMessage)

---

## 2026-01-09 - CLEAN-001
- Created `lib/constants.ts` with centralized constants
- Updated 5 route files to import from shared constants
- Constants centralized: DAILY_CHECKIN_POINTS (100), DAILY_CHECKPOINT_LIMIT (10), MAX_VARCHAR_LENGTH (255), MAX_LOCATIONS_PER_DAY (30)
- Added SUPABASE_ERROR_CODES object for standardized error code references
- Modified files:
  - lib/constants.ts (new)
  - app/api/checkin/route.ts
  - app/api/solana-checkin/route.ts
  - app/api/stellar-checkin/route.ts
  - app/api/locations/route.ts
  - app/api/location-checkin/route.ts
- **Learnings for future iterations:**
  - No `yarn typecheck` script - use `npx tsc --noEmit` instead
  - Pre-existing type errors in test files (leaderboard, player tests)
  - Pre-existing lint warnings (mostly `<img>` instead of `<Image />`)
---

## 2026-01-09 - CLEAN-002
- Created `lib/utils/date.ts` with shared `getUtcDayBounds()` function
- Updated 5 route files to import from shared date utility
- Removed 44 lines of duplicate code (net reduction of 44 lines)
- Modified files:
  - lib/utils/date.ts (new)
  - app/api/checkin/route.ts
  - app/api/solana-checkin/route.ts
  - app/api/stellar-checkin/route.ts
  - app/api/locations/route.ts
  - app/api/checkin-status/route.ts
- **Learnings for future iterations:**
  - checkin-status route also uses getUtcDayBounds (5 files total, not 4)
  - lib/utils/ directory now exists for categorized utility functions
---

## 2026-01-09 - CLEAN-003
- Created `lib/utils/validation.ts` with shared validation functions
- Consolidated 3 different sanitization functions into reusable utilities
- Added URL validation helper with protocol security checking
- Modified files:
  - lib/utils/validation.ts (new)
  - app/api/locations/route.ts (removed 32 lines)
  - app/api/location-checkin/route.ts (removed 14 lines)
- Net reduction: 59 lines removed, 68 lines added (consolidation + documentation)
- **Learnings for future iterations:**
  - sanitizeString returns undefined, sanitizeOptionalVarchar returns null (different null semantics)
  - validateUrl returns discriminated union for cleaner error handling
---

## 2026-01-09 - CLEAN-004
- Created `lib/api/checkin-handler.ts` with unified checkin business logic
- Consolidated daily limit checking, points awarding, activity insertion, response building
- Refactored all 3 checkin routes to use shared handler
- **Line reduction:** 475 lines → 141 lines in route files (70% reduction)
- Modified files:
  - lib/api/checkin-handler.ts (new, 263 lines)
  - app/api/checkin/route.ts (152 → 55 lines)
  - app/api/solana-checkin/route.ts (161 → 43 lines)
  - app/api/stellar-checkin/route.ts (162 → 43 lines)
- **Learnings for future iterations:**
  - Chain-specific wallet queries use different filter fields (user_wallet_address vs metadata->>solana_wallet)
  - Solana/Stellar routes now also use apiSuccess/apiError (CLEAN-005 partially addressed)
  - processCheckin returns discriminated union for type-safe error handling
---

## 2026-01-09 - CLEAN-005
- Audited all API routes for response patterns
- Migrated remaining raw Response() calls to apiSuccess/apiError helpers
- Modified files:
  - app/api/stellar-wallet/route.ts (9 Response() → helpers, 190 → 161 lines)
  - app/api/add-checkpoint/route.ts (4 Response() → helpers, 73 → 62 lines)
- **Net reduction:** 39 lines removed
- **Learnings for future iterations:**
  - solana-checkin and stellar-checkin were already using helpers (done in CLEAN-004)
  - Many routes still use NextResponse.json() - consistent enough, leave as-is
  - apiError only accepts specific status codes (400, 404, 429, 500) - map others appropriately
---

## 2026-01-09 - CLEAN-006
- Verified lib/cache/index.ts is ACTIVELY USED - no deletion needed
- Cache module used by: app/api/leaderboard/route.ts (leaderboardCache, playerStatsCache)
- Also tested in: app/api/leaderboard/__tests__/route.test.ts
- No code changes required - story premise was incorrect
- **Learnings for future iterations:**
  - Always verify "appears unused" claims before acting
  - leaderboardCache provides 30-second TTL caching for leaderboard data
  - playerStatsCache provides 30-second TTL caching for player stats
---

## 2026-01-09 - CLEAN-007
- Deleted lib/perks-api.ts (124 lines) - completely unused dead code
- File was never imported anywhere in the codebase
- hooks/usePerks.ts already provides equivalent functionality via apiClient
- No refactoring needed - deletion is the better outcome
- **Learnings for future iterations:**
  - Before refactoring, always check if code is even used (grep for imports)
  - Hooks pattern (usePerks.ts) has superseded utility-function pattern (perks-api.ts)
  - Unused code accumulates when new patterns replace old ones without cleanup
---

## 2026-01-09 - CLEAN-008
- Removed legacy checkin code from lib/db/checkins.ts
- Deleted functions: getCheckinByAddressAndCheckpoint, getCheckinByAddress, insertCheckin, upsertCheckpoint
- Removed deprecated Checkin type from lib/types.ts (7 lines)
- Updated DATA_LAYER_SCHEMA.md to remove deprecated references
- **Total lines removed:** ~78 lines (71 from checkins.ts, 7 from types.ts)
- Modified files:
  - lib/db/checkins.ts (107 → 36 lines)
  - lib/types.ts (removed Checkin type)
  - DATA_LAYER_SCHEMA.md (removed deprecated documentation)
- **Learnings for future iterations:**
  - Active checkin system uses player_location_checkins table, not checkins table
  - Legacy code marked "deprecated" in comments often can be safely deleted
  - Documentation files (DATA_LAYER_SCHEMA.md) should be updated alongside code changes
---

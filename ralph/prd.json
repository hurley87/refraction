{
  "project": "IRL Codebase Refactor",
  "branchName": "ralph/codebase-refactor",
  "description": "Incremental refactor to standardize API responses, decompose large components, and eliminate any types.",
  "userStories": [
    {
      "id": "API-001",
      "title": "Audit API response patterns",
      "description": "As a developer, I need a clear list of which API routes use response helpers vs raw NextResponse.json().",
      "acceptanceCriteria": [
        "Create ralph/api-audit.md documenting all 56 API routes",
        "Mark each route as: uses-helpers, uses-raw, or mixed",
        "List specific files and line numbers for raw NextResponse.json() usage",
        "Prioritize routes by traffic/importance"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Discovery task - no code changes, just documentation."
    },
    {
      "id": "TYPE-001",
      "title": "Replace catch (error: any) with proper error handling",
      "description": "As a developer, I need type-safe error handling to catch bugs at compile time.",
      "acceptanceCriteria": [
        "Replace catch (error: any) with catch (error: unknown) in app/api/claim-nft/route.ts",
        "Replace catch (error: any) with catch (error: unknown) in app/api/transfer-tokens/route.ts",
        "Add type guard: const message = error instanceof Error ? error.message : 'Unknown error'",
        "yarn build passes with no errors",
        "yarn lint passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "6 occurrences total. Mechanical fix."
    },
    {
      "id": "TYPE-002",
      "title": "Type rewards page redemption handlers",
      "description": "As a developer, I need proper types in rewards page to enable IDE autocomplete.",
      "acceptanceCriteria": [
        "Replace (redemption: any) with proper UserPerkRedemption type in app/rewards/page.tsx",
        "Import type from lib/types.ts or define locally if not exported",
        "Remove commented-out PerkCodeCount component (lines 85-104)",
        "yarn build passes",
        "yarn lint passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Single file cleanup."
    },
    {
      "id": "API-002",
      "title": "Standardize admin API routes",
      "description": "As a developer, I need consistent API responses across all admin endpoints.",
      "acceptanceCriteria": [
        "Convert app/api/admin/perks/route.ts to use apiSuccess/apiError helpers",
        "Convert app/api/admin/points-upload/route.ts to use apiSuccess/apiError helpers",
        "Convert app/api/admin/users/route.ts to use apiSuccess/apiError helpers",
        "Convert remaining admin routes (locations, checkins, etc.)",
        "All responses follow {success, data?, error?, message?} shape",
        "yarn build passes",
        "yarn test passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "8 routes total. Import from lib/api/response.ts."
    },
    {
      "id": "API-003",
      "title": "Standardize location and geocoding routes",
      "description": "As a developer, I need consistent responses for location-related endpoints.",
      "acceptanceCriteria": [
        "Convert app/api/locations/route.ts to use apiSuccess/apiError helpers",
        "Convert app/api/location-checkin/route.ts to use apiSuccess/apiError helpers",
        "Convert app/api/geocode-mapbox/route.ts to use apiSuccess/apiError helpers",
        "Convert app/api/geocode-nominatim/route.ts to use apiSuccess/apiError helpers",
        "yarn build passes",
        "yarn test passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "High-traffic routes. Also fixed any types with proper interfaces (MapboxFeature, NominatimPlace). Note: geocode-google route doesn't exist in codebase."
    },
    {
      "id": "API-004",
      "title": "Standardize perk routes",
      "description": "As a developer, I need consistent responses for perk-related endpoints.",
      "acceptanceCriteria": [
        "Convert app/api/perks/route.ts to use apiSuccess/apiError helpers consistently",
        "Convert app/api/perks/[id]/route.ts to use helpers",
        "Convert app/api/perks/[id]/codes/route.ts to use helpers",
        "Convert app/api/perks/codes/[codeId]/route.ts to use helpers",
        "Convert app/api/perks/redeem/route.ts to use helpers",
        "yarn build passes",
        "yarn test passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Revenue-critical. Most routes were already converted. Fixed remaining codes routes and added CodeRow interface."
    },
    {
      "id": "COMP-001",
      "title": "Decompose interactive-map.tsx",
      "description": "As a developer, I need smaller, testable components instead of one 2239-line file.",
      "acceptanceCriteria": [
        "Extract LocationFormDialog component to components/map/location-form-dialog.tsx",
        "Extract MarkerPopup component to components/map/marker-popup.tsx",
        "Extract map configuration/state to useMapState hook in hooks/useMapState.ts",
        "Main interactive-map.tsx reduced to under 500 lines",
        "No visual changes to map functionality",
        "yarn build passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Largest component. Extract incrementally, test after each extraction."
    },
    {
      "id": "COMP-002",
      "title": "Decompose admin location-lists page",
      "description": "As a developer, I need the 1943-line admin page broken into manageable pieces.",
      "acceptanceCriteria": [
        "Extract LocationListTable to app/admin/location-lists/components/location-list-table.tsx",
        "Extract LocationAssignmentDialog to app/admin/location-lists/components/assignment-dialog.tsx",
        "Extract useLocationLists hook to hooks/admin/useLocationLists.ts",
        "Main page.tsx reduced to under 400 lines",
        "Admin functionality unchanged",
        "yarn build passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Admin page - lower traffic, good candidate for refactor."
    },
    {
      "id": "TYPE-003",
      "title": "Fix publicClient and partners page types",
      "description": "As a developer, I need to eliminate remaining as any casts.",
      "acceptanceCriteria": [
        "Remove as any casts in lib/publicClient.ts with proper Viem types",
        "Remove as any casts in app/partners/page.tsx with proper component types",
        "Add missing type imports as needed",
        "yarn build passes",
        "yarn lint passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "4 occurrences fixed. publicClient needed no cast removal (Viem provides proper types). Partners page used LogoLoopProps interface."
    },
    {
      "id": "API-005",
      "title": "Standardize remaining API routes",
      "description": "As a developer, I need all remaining routes converted to use response helpers.",
      "acceptanceCriteria": [
        "Convert all remaining routes in app/api/ to use apiSuccess/apiError",
        "Verify no raw NextResponse.json() calls remain (except redirects)",
        "Update ralph/api-audit.md to mark all routes as complete",
        "yarn build passes",
        "yarn test passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Converted 17 routes: activities, add-user, admin/checkpoints, checkin-events, checkin-status, claim-nft, contact, newsletter, profile, location-comments, location-lists, number-assignment, transfer-tokens, update-airtable, upload. Fixed Supabase joined table array handling and ZodError instanceof check."
    }
  ]
}
